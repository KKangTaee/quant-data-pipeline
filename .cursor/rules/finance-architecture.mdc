---
description: Finance 모듈 아키텍처와 레이어 규칙
globs: finance/**/*.py
alwaysApply: false
---

# Finance 모듈 개요

- `finance/data/` : yfinance, MySQL 등 **외부 세계와의 경계 레이어**. 데이터 수집·저장·조회 전담.
- `finance/transform.py` : **순수 DataFrame → DataFrame 변환 레이어**. 수익률, 이평, 정렬, 교집합 정렬 등 계산.
- `finance/strategy.py` : **투자 의사결정 / 시뮬레이션 레이어**. 전략 함수와 `Strategy` 추상 클래스/구현체 위치.
- `finance/engine.py` : **BacktestEngine 파이프라인 레이어**. 데이터 로드 → 변환 → 전략 실행 → 결과 연결.
- `finance/performance.py` : **성과 지표 요약 레이어**. CAGR, Sharpe, MDD 등 계산.
- `finance/display.py` : **프레젠테이션 레이어**. 숫자 반올림, 스타일링 등 “사람이 보기 좋은 형태”로 정리.

# 작업 원칙

- **경계 분리**
  - 외부 API 호출(yfinance, Selenium 등)·DB(MySQL) 접근은 `finance/data/` 안에서만 수행한다.
  - 나머지 레이어에서는 **오직 in-memory 객체(DataFrame, dict 등)** 만 다룬다.

- **변환 로직 위치**
  - OHLCV 필터링, 수익률·이동평균·교집합 정렬·머지 같은 계산은 모두 `transform.py`에 함수로 둔다.
  - I/O 코드(파일/DB/HTTP)는 `transform.py`에 넣지 않는다.

- **전략 레이어 규칙**
  - 새로운 전략은 `strategy.py`에 함수 + `Strategy` 서브클래스로 추가한다.
  - `BacktestEngine.run()`에는 **항상 `Strategy` 구현체만** 주입해서 사용한다.

- **엔진 사용 규칙**
  - `BacktestEngine` 체이닝 메서드는 **상태를 변경한 뒤 self를 반환**하는 패턴을 유지한다.
  - 새 전처리 단계가 필요하면, `transform.py`에 함수 추가 → `BacktestEngine`에 얇은 래퍼 메서드를 붙이는 식으로 확장한다.

- **Display / Performance 분리**
  - 지표 계산(`CAGR`, `Sharpe`, `MDD` 등)은 `performance.py`에서, 시각적 표현(반올림, 색상 등)은 `display.py`에서 처리한다.
  - 전략/엔진 코드 안에서는 프레젠테이션 로직을 넣지 않는다.

- **타입·날짜 규칙**
  - `Date` 컬럼은 항상 `pd.to_datetime` 후 정렬한다.
  - `dict[str, DataFrame]` 구조를 사용할 때는 키(티커)와 DataFrame 컬럼(예: `"Ticker"`)이 의미적으로 일치하도록 유지한다.

# 사용 예 (요약)

- **단순 균등 전략 백테스트**
  - `BacktestEngine(tickers, period, option)`
    `.load_ohlcv()`
    `.add_ma(...)`
    `.filter_by_period()`
    `.align_dates()`
    `.run(EqualWeightStrategy(...))`

- **데이터 I/O와 분석 레이어 분리**
  - 시세 저장/조회: `store_ohlcv_to_mysql(...)`, `load_ohlcv_many_mysql(...)`를 통해 I/O 처리.
  - 분석·전략·백테스트 레이어에서는 DB 커넥션을 직접 열지 않고, 이미 준비된 DataFrame만 사용한다.

