---
description: Finance 데이터 레이어(yfinance/DB/스크래핑) 규칙
globs: finance/data/**/*.py
alwaysApply: false
---

# 데이터 레이어 개요

- `finance/data/data.py` : yfinance를 통한 OHLCV/FX 레이트 조회, MySQL 저장/조회 진입점.
- `finance/data/db/mysql.py` : `MySQLClient` 래퍼. 커넥션 열기/쿼리/DB 생성 전담.
- `finance/data/db/schema.py` : 가격 테이블 등 DDL 스키마 정의.
- `finance/data/nyse.py` : Selenium + BeautifulSoup 기반 NYSE 상장 종목 리스트 스크래핑.
- 그 외 `asset_profile.py`, `fundamentals.py`, `factors.py`, `data_format.py` 등은 각 데이터 도메인별 로더/정리 모듈로 사용.

# 설계 원칙

- **단일 경계(Single Boundary)**
  - 외부 HTTP 호출, 웹 스크래핑, DB 커넥션 등은 모두 이 디렉터리 안에서만 수행한다.
  - 다른 레이어(`transform`, `strategy`, `engine` 등)는 이 모듈들이 반환하는 **순수 Python 객체 / DataFrame**만 사용한다.

- **함수 역할 분리**
  - **데이터 가져오기**: `get_ohlcv`, `get_fx_rate`, `load_ohlcv_many_mysql`, `load_nyse_listings` 등은 “읽기 전용” 함수로 유지한다.
  - **저장/업서트**: `store_ohlcv_to_mysql`처럼 쓰기 동작은 이름에서 명확히 드러나게 하고, 커밋/에러 처리를 내부에서 끝낸다.

- **스키마·쿼리 관리**
  - 테이블 생성/DDL은 `schema.py`에 두고, 본문 코드에는 하드코딩하지 않는다.
  - SELECT/INSERT/UPSERT 쿼리는 가능하면 한 곳에서만 관리하고, 문자열 포맷 대신 파라미터 바인딩을 사용한다.

- **NaN / 누락값 처리**
  - DB 저장 전에는 `_to_none` 같은 헬퍼로 NaN/None을 정규화해서, DB에 모호한 값이 들어가지 않도록 한다.
  - yfinance 컬럼 케이스(`Adj Close`, `Dividends` 등)는 현재처럼 케이스-불변 매핑을 활용해 방어적으로 처리한다.

- **날짜/타임존 규칙**
  - DB에 저장하는 `date`는 날짜만 저장(`.dt.date`)하고, 애플리케이션에서 사용할 때는 `pd.to_datetime`으로 복원한다.
  - 타임존이 붙은 경우는 `tz_localize(None)`으로 제거해, 비교/조인 시 오류를 최소화한다.

- **리소스 관리**
  - `MySQLClient` 사용 후에는 `finally: db.close()` 패턴으로 커넥션을 항상 닫는다.
  - Selenium 드라이버는 `driver.quit()`을 호출해 브라우저 리소스를 정리한다.

# 새 기능 추가시 가이드

- 새로운 외부 데이터 소스(예: 다른 거래소, 새로운 API)를 붙일 때:
  - **이 디렉터리 안에 전용 모듈/함수**를 만든다. (예: `finance/data/krx.py`)
  - 반환 타입은 기존 패턴을 맞춰 `DataFrame` 또는 `dict[str, DataFrame]`으로 통일한다.

- DB 스키마가 바뀌면:
  - 먼저 `schema.py`의 DDL을 수정하고,
  - 그 다음 `store_ohlcv_to_mysql`, `load_ohlcv_many_mysql` 등의 쿼리를 함께 업데이트한다.

